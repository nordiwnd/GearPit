# --- Backend (Core) ---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: gearpit-previews-core
  namespace: argocd
spec:
  generators:
    - pullRequest:
        github:
          owner: nordiwnd
          repo: gearpit
          tokenRef:
            secretName: github-token
            key: token
        requeueAfterSeconds: 60
  template:
    metadata:
      name: 'preview-core-pr-{{number}}'
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: 'https://github.com/nordiwnd/gearpit.git'
        targetRevision: '{{head_sha}}' # マニフェスト自体のバージョンはCommit Hashに追従
        path: manifests/apps/gearpit-core/overlays/preview
        kustomize:
          images:
            # 重要: CIで生成される Mutable Tag (pr-123) を指定してHash不一致を回避
            - 'ghcr.io/nordiwnd/gearpit-app=ghcr.io/nordiwnd/gearpit-app:pr-{{number}}'
          namespace: 'pr{{number}}'
          patches:
            # Backend Ingress Patch (動的ホスト名)
            - target:
                kind: Ingress
                name: gearpit-ingress # base/ingress.yaml の名前と一致させること
              patch: |-
                - op: replace
                  path: /spec/rules/0/host
                  value: api-pr{{number}}.192.168.40.100.nip.io
      destination:
        server: https://kubernetes.default.svc
        namespace: 'pr{{number}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true

---
# --- Frontend (Web) ---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: gearpit-previews-web
  namespace: argocd
spec:
  generators:
    - pullRequest:
        github:
          owner: nordiwnd
          repo: gearpit
          tokenRef:
            secretName: github-token
            key: token
        requeueAfterSeconds: 60
  template:
    metadata:
      name: 'preview-web-pr-{{number}}'
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: 'https://github.com/nordiwnd/gearpit.git'
        targetRevision: '{{head_sha}}'
        path: manifests/apps/gearpit-web/overlays/preview
        kustomize:
          images:
            # 重要: CIで生成される Mutable Tag (pr-123) を指定
            - 'ghcr.io/nordiwnd/gearpit-web=ghcr.io/nordiwnd/gearpit-web:pr-{{number}}'
          namespace: 'pr{{number}}'
          patches:
            # Frontend Ingress Patch
            - target:
                kind: Ingress
                name: gearpit-web-ingress # base/ingress.yaml の名前と一致させること
              patch: |-
                - op: replace
                  path: /spec/rules/0/host
                  value: web-pr{{number}}.192.168.40.100.nip.io
            
            # Backend URL Injection Patch (動的接続先)
            - target:
                kind: Deployment
                name: gearpit-web
              patch: |-
                - op: replace
                  path: /spec/template/spec/containers/0/env/0
                  value:
                    name: BACKEND_URL
                    # Service名はCoreのService定義名(gearpit-app-svc)に合わせる
                    value: "http://gearpit-app-svc.pr{{number}}.svc.cluster.local:80"
      destination:
        server: https://kubernetes.default.svc
        namespace: 'pr{{number}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true