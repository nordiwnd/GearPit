name: Build and Push Apps

on:
  push:
    branches: [ "main" ]
    paths:
      - "apps/**"
      - ".github/workflows/build-app.yaml"
  pull_request:
    branches: [ "main" ]
    # paths:
    #   - "apps/**"
    #   - ".github/workflows/build-app.yaml"
  workflow_dispatch:

# 1. Concurrency: PRに対する連続プッシュ時に古いビルドをキャンセル
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  GIT_USER_NAME: "github-actions[bot]"
  GIT_USER_EMAIL: "github-actions[bot]@users.noreply.github.com"

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Manifest更新に必要
      packages: write # GHCRへのPushに必要
      # id-token: write # 将来的にOIDCを使うなら必要
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix:
        include:
          - app: gearpit-core
            context: ./apps/gearpit-core
            image: nordiwnd/gearpit-app
            manifest_path: manifests/apps/gearpit-core/overlays/main
          - app: gearpit-web
            context: ./apps/gearpit-web
            image: nordiwnd/gearpit-web
            manifest_path: manifests/apps/gearpit-web/overlays/main

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            src:
              - '${{ matrix.context }}/**'

      - name: Set Full SHA
        # PRのときは必ず実行、または変更があったら実行
        if: steps.changes.outputs.src == 'true' || github.event_name == 'pull_request'
        id: vars
        run: echo "sha_full=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Get PR Number
        if: github.event_name == 'pull_request'
        id: pr
        run: echo "num=${{ github.event.number }}" >> $GITHUB_OUTPUT

      # --- Docker Build Setup ---
      - name: Set up QEMU
        # 2. PRのときは変更検知を無視して必ずセットアップ（キャッシュが効くので時間はかからない）
        if: steps.changes.outputs.src == 'true' || github.event_name == 'pull_request'
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        if: steps.changes.outputs.src == 'true' || github.event_name == 'pull_request'
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to the Container registry
        if: steps.changes.outputs.src == 'true' || github.event_name == 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # --- Build & Push ---
      - name: Build and push Docker image
        # PR時は必ず実行して tag:pr-xx を生成する
        if: steps.changes.outputs.src == 'true' || github.event_name == 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ matrix.image }}:latest
            ${{ env.REGISTRY }}/${{ matrix.image }}:${{ steps.vars.outputs.sha_full }}
            ${{ github.event_name == 'pull_request' && format('{0}/{1}:pr-{2}', env.REGISTRY, matrix.image, steps.pr.outputs.num) || '' }}
          # キャッシュの設定は維持
          cache-from: type=gha,scope=${{ matrix.app }}
          cache-to: type=gha,mode=max,scope=${{ matrix.app }}

      # --- GitOps Update (PRの時は実行しない) ---
      - name: Setup Kustomize
        # ここは変更があった時のみ、かつPRではない時のみ（mainマージ時）
        if: steps.changes.outputs.src == 'true' && github.event_name != 'pull_request'
        uses: imranismail/setup-kustomize@v2

      - name: Update Manifest and Push
        if: steps.changes.outputs.src == 'true' && github.event_name != 'pull_request'
        run: |
          git config --global user.name "${{ env.GIT_USER_NAME }}"
          git config --global user.email "${{ env.GIT_USER_EMAIL }}"
          
          for i in {1..3}; do
            echo "Attempt $i: Updating manifest for ${{ matrix.app }}..."
            git pull origin main --rebase
            
            cd ${{ github.workspace }}/${{ matrix.manifest_path }}
            kustomize edit set image ${{ env.REGISTRY }}/${{ matrix.image }}=${{ env.REGISTRY }}/${{ matrix.image }}:${{ steps.vars.outputs.sha_full }}
            
            cd ${{ github.workspace }}
            
            if [[ -n $(git status -s) ]]; then
              git add .
              git commit -m "ops: update ${{ matrix.app }} image to ${{ steps.vars.outputs.sha_full }} [skip ci]"
              
              if git push origin main; then
                echo "Successfully updated manifest."
                break
              else
                echo "Push failed. Retrying..."
                git reset --hard HEAD~1
                sleep $((RANDOM % 5 + 2))
              fi
            else
              echo "No changes needed."
              break
            fi
          done
